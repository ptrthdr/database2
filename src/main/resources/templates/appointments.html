<!DOCTYPE html>
<html lang="pl" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>Moje wizyty</title>

    <style>
        body {
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(to bottom, #f8fafc, #eef2f7);
            font-family: system-ui, sans-serif;
        }

        main {
            display: flex;
            justify-content: center;
            padding: 3rem 1.5rem;
        }

        .panel {
            background: white;
            max-width: 1000px;
            width: 100%;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 30px 60px rgba(15, 23, 42, .15);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .appointments {
            display: grid;
            gap: 1.5rem;
        }

        .appointment {
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 1.6rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .label {
            font-size: .75rem;
            color: #64748b;
            text-transform: uppercase;
        }

        .value {
            font-weight: 500;
        }

        .status {
            font-weight: 600;
        }

        .actions {
            display: flex;
            gap: .5rem;
            align-items: center;
        }

        button {
            border-radius: 8px;
            border: none;
            padding: .45rem .9rem;
            cursor: pointer;
        }

        .cancel {
            background: #fee2e2;
            color: #991b1b;
        }

        .empty {
            text-align: center;
            color: #64748b;
            padding: 3rem 0;
        }
    </style>
</head>

<body>

    <div th:replace="fragments/header :: body"></div>

    <main>
        <div class="panel">

            <div class="panel-header">
                <h2 sec:authorize="hasRole('CLIENT')">Moje wizyty</h2>
                <h2 sec:authorize="hasRole('ADVISOR')">Wizyty klientów</h2>
            </div>

            <!-- ===== LISTA WIZYT ===== -->
            <div class="appointments" th:if="${appointments != null and !appointments.isEmpty()}">

                <div class="appointment" th:each="a : ${appointments}">

                    <div>
                        <div class="label">Data</div>
                        <div class="value" th:text="${#temporals.format(a.slot.startDateTime, 'dd.MM.yyyy HH:mm')}">
                            data
                        </div>
                    </div>

                    <div>
                        <div class="label">Doradca</div>
                        <div class="value"
                            th:text="${a.slot.advisor.user.firstName + ' ' + a.slot.advisor.user.lastName}">
                            doradca
                        </div>
                    </div>

                    <div>
                        <div class="label">Usługa</div>
                        <div class="value" th:text="${a.slot.service.name}">
                            usługa
                        </div>
                    </div>

                    <div>
                        <div class="label">Status</div>
                        <div class="value status" th:text="${a.slot.status}">
                            status
                        </div>
                    </div>

                    <!-- ===== ANULOWANIE ===== -->
                    <div class="actions">
                        <form th:action="@{/appointments/{id}/cancel(id=${a.id})}" method="post">

                            <!-- ✅ NULL-SAFE CSRF -->
                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}"
                                th:value="${_csrf.token}" />

                            <button type="submit" class="cancel">
                                Anuluj
                            </button>
                        </form>
                    </div>

                </div>
            </div>

            <!-- ===== BRAK WIZYT ===== -->
            <div class="empty" th:if="${appointments == null or appointments.isEmpty()}">
                Nie masz jeszcze żadnych wizyt.
            </div>

        </div>
    </main>

</body>

</html>