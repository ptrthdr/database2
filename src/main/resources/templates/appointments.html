<!DOCTYPE html>
<html lang="pl" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>Wizyty</title>

    <style>
        body {
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(to bottom, #f8fafc, #eef2f7);
            font-family: system-ui, sans-serif;
        }

        main {
            display: flex;
            justify-content: center;
            padding: 3rem 1.5rem;
        }

        .panel {
            background: white;
            max-width: 1100px;
            width: 100%;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 30px 60px rgba(15, 23, 42, .15);
        }

        .panel-header {
            margin-bottom: 1.5rem;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filters select,
        .filters input {
            padding: .45rem .7rem;
            border-radius: 8px;
            border: 1px solid #cbd5f5;
        }

        .filters button {
            padding: .45rem 1rem;
            border-radius: 8px;
            border: none;
            background: #2563eb;
            color: white;
            cursor: pointer;
        }

        .appointments {
            display: grid;
            gap: 1.5rem;
        }

        .appointment {
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 1.6rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .label {
            font-size: .75rem;
            color: #64748b;
            text-transform: uppercase;
        }

        .value {
            font-weight: 500;
        }

        .status {
            font-weight: 600;
        }

        .status.ZAREZERWOWANY {
            color: #2563eb;
        }

        .status.ZAKONCZONA {
            color: #64748b;
        }

        .actions button {
            background: #fee2e2;
            color: #991b1b;
            border: none;
            border-radius: 8px;
            padding: .4rem .9rem;
            cursor: pointer;
        }

        .empty {
            text-align: center;
            color: #64748b;
            padding: 3rem 0;
        }
    </style>
</head>

<body>

    <div th:replace="~{fragments/header :: body}"></div>

    <main>
        <div class="panel">

            <div class="panel-header">
                <h2 sec:authorize="hasRole('CLIENT')">Moje wizyty</h2>
                <h2 sec:authorize="hasRole('ADVISOR')">Wizyty klientów</h2>
            </div>

            <!-- ===== FILTRY ===== -->
            <form class="filters" method="get" th:action="@{/appointments}">

                <select name="status">
                    <option value="">Wszystkie statusy</option>
                    <option value="ZAREZERWOWANY" th:selected="${status == 'ZAREZERWOWANY'}">
                        ZAREZERWOWANY
                    </option>
                    <option value="ZAKONCZONA" th:selected="${status == 'ZAKONCZONA'}">
                        ZAKONCZONA
                    </option>
                </select>

                <input type="text" name="query" placeholder="Imię, nazwisko lub ID" th:value="${query}" />

                <button type="submit">Filtruj</button>
            </form>

            <!-- ===== LISTA WIZYT ===== -->
            <div class="appointments" th:if="${appointments != null and !appointments.isEmpty()}">

                <div class="appointment" th:each="a : ${appointments}">

                    <div>
                        <div class="label">Data</div>
                        <div class="value" th:text="${#temporals.format(a.slot.startDateTime,'dd.MM.yyyy HH:mm')}">
                        </div>
                    </div>

                    <div sec:authorize="hasRole('CLIENT')">
                        <div class="label">Doradca</div>
                        <div class="value" th:text="${a.slot.advisor.user.firstName
                         + ' ' + a.slot.advisor.user.lastName
                         + ' (ID: ' + a.slot.advisor.user.id + ')'}">
                        </div>
                    </div>

                    <div sec:authorize="hasRole('ADVISOR')">
                        <div class="label">Klient</div>
                        <div class="value" th:text="${a.client.firstName
                         + ' ' + a.client.lastName
                         + ' (ID: ' + a.client.id + ')'}">
                        </div>
                    </div>

                    <div>
                        <div class="label">Usługi</div>
                        <div class="value">
                            <span th:each="s, i : ${a.slot.services}" th:text="${s.name + (i.last ? '' : ', ')}">
                            </span>
                        </div>
                    </div>

                    <div>
                        <div class="label">Status</div>
                        <div class="value status" th:classappend="${a.slot.status}" th:text="${a.slot.status}">
                        </div>
                    </div>

                    <div class="actions" th:if="${a.slot.status.name() == 'ZAREZERWOWANY'}">
                        <form th:action="@{/appointments/{id}/cancel(id=${a.id})}" method="post">
                            <button type="submit">Anuluj</button>
                        </form>
                    </div>

                </div>
            </div>

            <div class="empty" th:if="${appointments == null or appointments.isEmpty()}">
                Brak wizyt.
            </div>

        </div>
    </main>

</body>

</html>